project(yolov8ncnn)

cmake_minimum_required(VERSION 3.10)

# æ‰“å°ANDROID_ABIå€¼ç”¨äºè°ƒè¯•
message(STATUS "ğŸ” å½“å‰ANDROID_ABI: ${ANDROID_ABI}")
message(STATUS "ğŸ” å½“å‰CMAKE_ANDROID_ARCH_ABI: ${CMAKE_ANDROID_ARCH_ABI}")
# è®¾ç½®ç›®æ ‡ ABI

INCLUDE_DIRECTORIES(${CMAKE_SOURCE_DIR}/eigen-3.3.9)

set(OpenCV_DIR ${CMAKE_SOURCE_DIR}/OpenCV-android-sdk/sdk/native/jni)
find_package(OpenCV REQUIRED core imgproc highgui)

set(ncnn_DIR ${CMAKE_SOURCE_DIR}/ncnn-20231027-android-vulkan/${ANDROID_ABI}/lib/cmake/ncnn)
find_package(ncnn REQUIRED)

include_directories(${CMAKE_SOURCE_DIR}/ffmpeg-5.9/arm64-v8a/include)
link_directories(${CMAKE_SOURCE_DIR}/ffmpeg-5.9/arm64-v8a/lib)
include_directories(${CMAKE_SOURCE_DIR}/x264/arm64-v8a/include)
link_directories(${CMAKE_SOURCE_DIR}/x264/arm64-v8a/lib)
include_directories(${CMAKE_CURRENT_SOURCE_DIR})

include_directories(${CMAKE_SOURCE_DIR}/track)
include_directories(${CMAKE_SOURCE_DIR}/detect)
include_directories(${CMAKE_SOURCE_DIR}/seg)
include_directories(${CMAKE_SOURCE_DIR}/pose)
file(GLOB TRACK_SRCS "track/*.cpp")
file(GLOB DETECT_SRCS "detect/*.cpp")
file(GLOB SEG_SRCS "seg/*.cpp")
file(GLOB POSE_SRCS "pose/*.cpp")

# å¼ºåˆ¶åŒ…å«æ‰€æœ‰å¿…è¦çš„FFmpegé™æ€åº“
set(FFMPEG_LIBS "")
set(FFMPEG_STATIC_LIBS
        libavutil.a
        libswresample.a  # å¼ºåˆ¶åŒ…å«ï¼Œè§£å†³swr_allocé—®é¢˜
        libswscale.a
        libavcodec.a
        libavformat.a
)

# æ£€æŸ¥x264é™æ€åº“
set(X264_LIB_PATH ${CMAKE_SOURCE_DIR}/x264/arm64-v8a/lib/libx264.a)
if(EXISTS ${X264_LIB_PATH})
    file(SIZE ${X264_LIB_PATH} x264_size)
    if(x264_size GREATER 1000000)
        message(STATUS "âœ… æ‰¾åˆ°x264åº“: libx264.a (${x264_size} bytes)")
        set(X264_LIBS ${X264_LIB_PATH})
    else()
        message(WARNING "âš ï¸ x264åº“æ–‡ä»¶å¤ªå°: libx264.a (${x264_size} bytes)")
        set(X264_LIBS "")
    endif()
else()
    message(WARNING "âŒ x264åº“ä¸å­˜åœ¨: ${X264_LIB_PATH}")
    set(X264_LIBS "")
endif()

# å¼ºåˆ¶æ£€æŸ¥å¹¶æ·»åŠ FFmpegé™æ€åº“
foreach(lib ${FFMPEG_STATIC_LIBS})
    set(lib_path ${CMAKE_SOURCE_DIR}/ffmpeg-5.9/arm64-v8a/lib/${lib})
    if(EXISTS ${lib_path})
        file(SIZE ${lib_path} lib_size)
        message(STATUS "ğŸ“¦ å¼ºåˆ¶æ·»åŠ FFmpegåº“: ${lib} (${lib_size} bytes)")
        list(APPEND FFMPEG_LIBS ${lib_path})
    else()
        message(ERROR "âŒ å¿…éœ€çš„FFmpegåº“ä¸å­˜åœ¨: ${lib_path}")
        # å¦‚æœå…³é”®åº“ä¸å­˜åœ¨ï¼Œç¦ç”¨FFmpegåŠŸèƒ½
        set(FFMPEG_LIBS "")
        break()
    endif()
endforeach()

# å¦‚æœé™æ€åº“ä¸å¯ç”¨ï¼Œå°è¯•åŠ¨æ€åº“ä½œä¸ºå¤‡é€‰
if(NOT FFMPEG_LIBS)
    message(STATUS "ğŸ”„ é™æ€åº“ä¸å¯ç”¨ï¼Œå°è¯•åŠ¨æ€åº“...")
    set(FFMPEG_SHARED_LIBS
            avutil
            swresample  # å¼ºåˆ¶åŒ…å«éŸ³é¢‘é‡é‡‡æ ·åº“
            swscale
            avcodec
            avformat
    )
    foreach(lib ${FFMPEG_SHARED_LIBS})
        list(APPEND FFMPEG_LIBS ${lib})
        message(STATUS "ğŸ”— æ·»åŠ FFmpegåŠ¨æ€åº“: ${lib}")
    endforeach()
endif()

if(FFMPEG_LIBS)
    message(STATUS "ğŸ“¦ ä½¿ç”¨FFmpegåº“: ${FFMPEG_LIBS}")
    if(X264_LIBS)
        message(STATUS "ğŸ“¦ ä½¿ç”¨x264åº“: ${X264_LIBS}")
    endif()
    add_library(yolov8ncnn SHARED
            main.cpp
            ffmpeg_main.cpp
            yolo_common.cpp
            ndkcamera.cpp
            globals.cpp
            ${TRACK_SRCS}
            ${DETECT_SRCS}
            ${SEG_SRCS}
            ${POSE_SRCS}
    )
else()
    message(WARNING "ğŸš« æœªæ‰¾åˆ°æœ‰æ•ˆçš„FFmpegåº“ï¼Œç¦ç”¨FFmpegåŠŸèƒ½")
endif()

# é“¾æ¥åº“ - å¼ºåˆ¶åŒ…å«æ‰€æœ‰å¿…è¦çš„åº“
target_link_libraries(yolov8ncnn
        ncnn
        ${OpenCV_LIBS}
        camera2ndk
        mediandk
        ${FFMPEG_LIBS}
        ${X264_LIBS}
        z m c  dl )# FFmpegä¾èµ–åº“